<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Priority Selection</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="data.js"></script> <!-- Include the external JS file -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #b6d2ed;
            color: #333;
        }

        body {
    text-align: center; /* Center child elements horizontally */
    background-color: #96c1ec; /* Optional: background color for visibility */
}

        .priority-container {
            border: 2px solid #007bff;
            border-radius: 5px;
            background-color: #e9ecef; /* Different color for the container */
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            min-height: 60px; /* Fixed height for the container */
            display: flex;
            align-items: center; /* Center items vertically */
        }

        .priority-container.fixed {
            background-color: #0056b3; /* Darker blue background color for active state */
        }

        .priority-list {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            overflow-x: auto;
            flex-wrap: nowrap; /* Ensure items stay in a single line */
        }

        .priority-item {
            padding: 10px 20px;
            border: 1px solid #007bff;
            border-radius: 5px;
            background-color: #ffffff;
            color: #007bff;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .buttons {
            margin-bottom: 20px;
        }

        .buttons button {
            margin-right: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        .buttons button:hover {
            background-color: #0056b3;
        }

        .buttons button:active {
            transform: scale(0.98);
        }

        /* Styling for disabled buttons */
button:disabled, /* For natively disabled buttons */
button.disabled { /* For buttons with the 'disabled' class */
    background-color: #6c9fd2; /* Light gray color */
    color: #efefef; /* Darker gray text */
    cursor: not-allowed; /* Change cursor to indicate it's disabled */
    pointer-events: none; /* Disable clicking on the button */
}

.finalize-btn, .reset-btn {
    padding: 10px 20px;
    margin-bottom: 50px;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
}

/* Finalize button styles */
.finalize-btn {
    background-color: #28a745;
    color: #fff;
}

.finalize-btn:hover {
    background-color: #218838;
}

.finalize-btn:active {
    transform: scale(0.98);
}

/* Disabled finalize button */
.finalize-btn:disabled {
    background-color: #a6dfb1; /* Lighter green */
    color: #d5f2e2; /* Lighter text */
    cursor: not-allowed; /* Indicate it's disabled */
    pointer-events: none; /* Prevent interaction */
}

/* Reset button styles */
.reset-btn {
    background-color: #dc3545;
    color: #fff;
    margin-left: 10px;
}

.reset-btn:hover {
    background-color: #c82333;
}

.reset-btn:active {
    transform: scale(0.98);
}

/* Disabled reset button */
.reset-btn:disabled {
    background-color: #e6a1a8; /* Lighter red */
    color: #f6d4d8; /* Lighter text */
    cursor: not-allowed; /* Indicate it's disabled */
    pointer-events: none; /* Prevent interaction */
}


.form-container {
    display: flex;
    flex-direction: column; /* Stack form elements vertically */
    align-items: flex-start; /* Align items to the left */
    width: 100%; /* Ensure the container takes up the full width */
    max-width: 800px; /* Optional: limit the maximum width of the container */
    margin: 0 auto; /* Center the container horizontally if max-width is set */
}

/* Style for labels and inputs to be on the same line */
.form-group-label {
    margin-bottom: 15px;
    display: flex;
    align-items: center; /* Align items to the center vertically */
    width: 100%; /* Full width for the form group */
}

.form-group-label label {
    font-weight: bold;
    margin-right: 10px; /* Space between label and input field */
    min-width: 200px; /* Set a minimum width for the label */
    text-align: left; /* Ensure label text is aligned to the left */
}

.form-group-label input[type="number"] {
    padding: 8px;
    border: 1px solid #ced4da;
    border-radius: 5px;
    width: 100px; /* Width for number fields */
    box-sizing: border-box;
}

/* Style for radio buttons to align them properly */
.form-group-radio {
    margin-bottom: 15px;
}

.form-group-radio label {
    font-weight: bold;
    margin-bottom: 5px; /* Space between label and radio group */
    display: block; /* Ensure the label is on its own line */
    text-align: left; /* Align label text to the left */
}

.radio-group {
    display: flex;
    flex-direction: column; /* Stack radio buttons vertically */
}

.radio-group label {
    font-weight: normal;
    margin-bottom: 5px; /* Space between radio button options */
    display: flex; /* Ensure label text and radio button are aligned horizontally */
    align-items: center; /* Align radio button with label text */
}

.radio-group input[type="radio"] {
    margin-right: 5px; /* Space between radio button and label text */
}

#chartInfo {
    text-align: left;
    margin-bottom: 20px;
    color: #333; /* Default text color */
}

#chartInfo p {
    font-size: 30px; /* Increase font size */
    font-weight: bold; /* Make text bold */
    color: #007bff; /* Change text color */
    margin: 5px 0; /* Add some space between lines */
}

.wishes-group {
    display: flex;
    flex-direction: column; /* Stack label and input vertically */
    align-items: center; /* Center align children horizontally */
    width: 100%; /* Full width to ensure centering works */
}

/* Style for the specific "Number of wishes" label */
#wishesLabel {
    font-size: 20px; /* Increase the font size */
    font-weight: bold; /* Make the text bold */
    color: #007bff; /* Make the text color prominent */
    margin-bottom: 10px; /* Space between label and input field */
    text-align: center; /* Center align the text */
    width: 100%; /* Make the label span the full width of its container */
}

/* Style for the number input within the specific group */
.wishes-group input[type="number"] {
    text-align: center; /* Center align the input text */
}
    </style>
</head>
<body>
    <h1>Prioridade</h1>

    <div class="priority-container">
        <div class="priority-list" id="priorityList"></div>
    </div>
    <h3>Clique nos botoes a baixo para definir sua prioridade de pull. </h3>
    <div class="buttons">
        <button id="C0">C0</button>
        <button id="R1">R1</button>
    </div>
    <p><i>Cx (C0, C1, C2, C3...) significa o personagem, e Rx (R1, R2, R3...) significa sua arma assinatura.</i></p>
    <p><i>Ex: se seu objetivo for o personagem C2R1, e sua prioridade for pegar uma cópia, depois a arma, e depois as constelacoes, você adicionaria: C0 -> R1 -> C1 -> C2 -> Definir prioridade</i></p>
    <div class="actions">
        <button class="finalize-btn" id="finalizeBtn">Definir prioridade</button>
        <button class="reset-btn" id="resetBtn">Resetar prioridade</button>
    </div>
    <h1>Estado atual dos banners</h1>
    <div class="form-group-label">
        <label for="charPity">Tiros dados desde o último personagem 5*:</label>
        <input type="number" id="charPity" value="0" min="0" max="89"/>
    </div>

    <div class="form-group-radio">
        <label>Você está no garantido? Ou último personagem foi um personagem do banner limitado?</label>
        <div class="radio-group">
            <label><input type="radio" name="charGuaranteed" value="yes" /> Estou no garantido do banner de personagem</label>
            <label><input type="radio" name="charGuaranteed" value="no" checked /> Estou no 50/50</label>
        </div>
    </div>

    <div class="form-group-label">
        <label for="weapPity">Tiros dados desde a última arma 5*:</label>
        <input type="number" id="weapPity"  value="0" min="0" max="79"/>
    </div>

    <div class="form-group-radio">
        <label>Você está no garantido? Ou a última arma foi uma arma do banner limitado?</label>
        <div class="radio-group">
            <label><input type="radio" name="weapGuaranteed" value="yes" /> Estou no garantido do banner de armas</label>
            <label><input type="radio" name="weapGuaranteed" value="no" checked /> Estou no 75/25</label>
        </div>
    </div>

    <div class="form-group-radio">
        <label>No banner de armas, como estao seus Fate Points? <br>(Fate point é o número de vezes que você pegou uma arma diferente da selecionada. Ele reseta para 0 no início de todo novo banner.)</label>
        <div class="radio-group">
            <label><input type="radio" name="weapFate" value="no" checked/> 0 </label>
            <label><input type="radio" name="weapFate" value="yes" /><p>1 - A última arma 5* que tirei no banner de armas <strong> atual </strong> foi diferente da selecionada.</p></label>
        </div>
    </div>

    <h1>Simulações</h1>
    <div class="form-group-label wishes-group">
        <label for="wishesInput" id="wishesLabel">Número de tiros (Destinos Entrelaçados)</label>
        <input type="number" id="wishesInput" value="0"/>
    </div>

    <div class="actions">
        <button class="finalize-btn" id="genBtn" onclick="generateChart()" disabled>Gerar resultados</button>
    </div>

    <script src="script.js"></script>

    <div id="chartInfo" style="text-align: left; margin-bottom: 20px;">
        <p id="successRate"></p>
        <p id="avgWishesLeft"></p>
    </div>

    <canvas id="myBarChart" style="display:none;"></canvas>

    <script type="module">
        let resultArray = [];

        const chance_char = 6;
        const chance_pity_char = [
            66, 126, 186, 246, 306, 366, 426, 486, 546, 606, 666, 726, 786, 846, 906, 966, 1000
        ];

        const chance_weap = 7;
        const chance_pity_weap = [
            77, 147, 217, 287, 357, 427, 497, 567, 637, 707, 777, 847, 917, 987, 1000, 1000, 1000, 1000
        ];

        function getRandomInt(max) {
            return Math.floor(Math.random() * max) + 1;
        }

        function calc(wishes, priority, goal_char = 1, goal_weap = 0, pity_char = 0, garanteed_char_p = false, pity_weap = 0, garanteed_weap = false, radiance_garanteed = false) {
            let banner_char = 0;
            let banner_weap = 0;
            // let pity_char = 0;
            // let pity_weap = 0;
            let guaranteed_char = garanteed_char_p;
            let guaranteed_banner_weapon = garanteed_weap;
            let guaranteed_weapon = radiance_garanteed;

            let spent_wishes = 0;

            for (let i = 0; i < 12; i++) {
                if (priority[i] === 0) {
                    while (spent_wishes < wishes && banner_char < goal_char) {
                        spent_wishes++;
                        pity_char++;
                        let chance = chance_char;

                        if (pity_char >= 74) {
                            chance = chance_pity_char[pity_char - 74];
                        }

                        if (getRandomInt(1000) <= chance) {
                            if (!guaranteed_char && getRandomInt(1000) <= 500) {
                                guaranteed_char = true;
                                pity_char = 0;
                            } else {
                                guaranteed_char = false;
                                pity_char = 0;
                                banner_char++;
                                break;
                            }
                        }
                    }
                }

                if (priority[i] === 1) {
                    while (spent_wishes < wishes && banner_weap < goal_weap) {
                        spent_wishes++;
                        pity_weap++;
                        let chance = chance_weap;

                        if (pity_weap >= 63) {
                            chance = chance_pity_weap[pity_weap - 63];
                        }

                        if (getRandomInt(1000) <= chance) {
                            if (guaranteed_weapon) {
                                guaranteed_weapon = false;
                                guaranteed_banner_weapon = false;
                                pity_weap = 0;
                                banner_weap++;
                                break;
                            } else if (!guaranteed_banner_weapon && getRandomInt(1000) <= 250) {
                                guaranteed_banner_weapon = true;
                                guaranteed_weapon = true;
                                pity_weap = 0;
                            } else {
                                guaranteed_banner_weapon = false;
                                pity_weap = 0;
                                if (getRandomInt(1000) <= 500) {
                                    guaranteed_weapon = false;
                                    banner_weap++;
                                    break;
                                } else {
                                    guaranteed_weapon = true;
                                }
                            }
                        }
                    }
                }
            }

            return { banner_char, banner_weap, spent_wishes };
        }

        function cumulativeFromEnd(arr) {
            let cumulativeArr = [...arr];
            for (let i = arr.length - 2; i >= 0; i--) {
                cumulativeArr[i] += cumulativeArr[i + 1];
            }
            return cumulativeArr;
        }

        function simulate(wishes, prio, pity_char, garanteed_char, pity_weap, garanteed_weap, garanteed_fate_weap, simulations = 10000) {
            let success = 0;
            let left = 0;
            let sim_weight = 100.0 / simulations;

            let goal_weap = 0;
            let goal_char = 0;
            for (let i = 0; i < prio.length; i++) {
                if (prio[i] == 0) {
                    goal_char++;
                }
                if (prio[i] == 1) {
                    goal_weap++;
                }
            }

            let arr = new Array(13).fill(0);
            let weap_avg = 0;

            for (let i = 0; i < simulations; i++) {
                let { banner_char, banner_weap, spent_wishes } = calc(wishes, prio, goal_char, goal_weap, pity_char, garanteed_char, pity_weap, garanteed_weap, garanteed_fate_weap);

                if (banner_char === goal_char && banner_weap === goal_weap) {
                    success++;
                }

                left += (wishes - spent_wishes);
                arr[(banner_weap + banner_char)] += sim_weight;
                weap_avg += banner_weap;
            }

            let result_data = cumulativeFromEnd(arr).map(value => value.toFixed(1));
            success = (success * 100.0) / simulations;
            let leftover_wishes_avg = left / simulations;

            return {result_data, success, leftover_wishes_avg};
        }

        function getLabels(priority) {
            let labels = new Array(13).fill('');
            let char_label = '-';
            let char_num = 0;
            let weap_label = '';
            let weap_num = 0;
            for (let i = 0; i < 13; i++) {
                if (priority[i] === 0) {
                    char_num += 1;
                    char_label = "C" + (char_num - 1).toString();
                }
                if (priority[i] === 1) {
                    weap_num += 1;
                    weap_label = "R" + (weap_num).toString();
                }
                labels[i] = char_label + weap_label;
            }
            return labels;
        }

        window.generateChart = async function() {
            try {
                // Get the value of the wishes input
                const wishes = document.getElementById('wishesInput').value;
                if (wishes == 0) {
                    alert("Adicione o número de tiros!")
                    return;
                }
                // Get the value of the wishes input
                const pity_char = document.getElementById('charPity').value;
                // Get the value of the wishes input
                const pity_weap = document.getElementById('weapPity').value;

                const charGaranteed = document.querySelector('input[name="charGuaranteed"]:checked').value == "yes";
                const weapGaranteed = document.querySelector('input[name="weapGuaranteed"]:checked').value == "yes";
                const weapFate = document.querySelector('input[name="weapFate"]:checked').value == "yes";

                // const wishes = 100; // Adjust this value as needed
                const prio = resultArray;
                let {result_data, success, leftover_wishes_avg} = simulate(wishes, prio, pity_char, charGaranteed, pity_weap, weapGaranteed, weapFate);

                const threshold = 0.1;
                let labels_original = getLabels(prio);

                // Filter the array to remove values lower than the threshold
                let dataArray = result_data;
                dataArray.shift();
                dataArray = dataArray.filter(value => value >= threshold);
                let labels = labels_original.slice(0, dataArray.length);

                while (dataArray.length < 3) {
                    dataArray.push(0);
                    labels.push('');
                }

                // Update chart info text
                document.getElementById('successRate').innerText = `Chance de pegar ${labels_original[labels_original.length - 1]}: ${success.toFixed(2)}%`;
                document.getElementById('avgWishesLeft').innerText = `Média do número de desejos que sobraram no fim: ${leftover_wishes_avg.toFixed(2)}`;

                // Get the context of the canvas
                const ctx = document.getElementById('myBarChart').getContext('2d');

                // Destroy the existing chart if it exists
                if (window.myBarChart && window.myBarChart.destroy) {
                    window.myBarChart.destroy();
                }

                // Create a new Chart
                window.myBarChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Percentage Data',
                            data: dataArray,
                            backgroundColor: 'rgba(248, 131, 54, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                min: 0,  // Set the minimum value to 0
                                max: 100,  // Set the maximum value to 100
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(tooltipItem) {
                                        return tooltipItem.raw + '%';
                                    }
                                }
                            }
                        }
                    }
                });

                // Show the canvas
                document.getElementById('myBarChart').style.display = 'block';

            } catch (error) {
                console.error("Error generating chart:", error); // Log any errors
            }
        }
    const finalizeBtn = document.getElementById('finalizeBtn');

            // Handle finalize button click
    finalizeBtn.addEventListener('click', () => {
        
        const genBtn = document.getElementById('genBtn');
        const items = Array.from(priorityList.children);
        resultArray = new Array(12).fill(2); // Default value 2
        finalizeBtn.disabled = true;
        finalizeBtn.classList.add('disabled'); // Visual feedback for disabled button

        document.querySelectorAll('.priority-container').forEach(container => {
            container.classList.add('fixed'); // Remove disabled visual feedback
        });

        document.querySelectorAll('.buttons button').forEach(button => {
            button.innerText = button.id; // Set button text back to initial
            button.disabled = true;
            button.classList.add('disabled'); // Remove disabled visual feedback
        });

        items.forEach(item => {
            const text = item.innerText;
            const index = Array.from(priorityList.children).indexOf(item);
            if (text.startsWith('C')) {
                resultArray[index] = 0;
            } else if (text.startsWith('R')) {
                resultArray[index] = 1;
            }
        });

        genBtn.disabled = false;
    });

    document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('charPity');
    const min = parseInt(input.min, 10);
    const max = parseInt(input.max, 10);

    function validateValue() {
        let value = parseInt(input.value, 10);

        if (isNaN(value)) {
            value = min; // Optional: set to min if empty or invalid
        } else if (value < min) {
            value = min;
        } else if (value > max) {
            value = max;
        }

        input.value = value;
    }

    input.addEventListener('input', validateValue);
    input.addEventListener('blur', validateValue);
});

document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('weapPity');
    const min = parseInt(input.min, 10);
    const max = parseInt(input.max, 10);

    function validateValue() {
        let value = parseInt(input.value, 10);

        if (isNaN(value)) {
            value = min; // Optional: set to min if empty or invalid
        } else if (value < min) {
            value = min;
        } else if (value > max) {
            value = max;
        }

        input.value = value;
    }

    input.addEventListener('input', validateValue);
    input.addEventListener('blur', validateValue);
});
    </script>
    
</body>
</html>
